# Creating a Network Tier with Subnets and a Route Table in a VPC

# Problem:
# You have a VPC and need to create a network layout consisting of individual IP spaces
# for segmentation and redundancy.

# Solution:
# Create a route table within your VPC. Create two subnets in separate Availability
# Zones in a VPC. Associate the route table with the subnets.

# Prerequisite: A VPC

# Steps

# Create a route table. This will allow you to create customized traffic routes for
# subnets associated with it:
ROUTE_TABLE_ID=$(aws ec2 create-route-table --vpc-id $VPC_ID \
--tag-specifications \
'ResourceType=route-table,Tags=[{Key=Name,Value=DemoRouteTable}]' \
--output text --query RouteTable.RouteTableId)

# Create two subnets, one in each AZ. This will define the address spaces for you to
# create resources for your VPC:
SUBNET_ID_1=$(aws ec2 create-subnet --vpc-id $VPC_ID \
--cidr-block 10.10.0.0/24 --availability-zone ${AWS_REGION}a \
--tag-specifications \
'ResourceType=subnet,Tags=[{Key=Name,Value=DemoSubnet1}]' \
--output text --query Subnet.SubnetId)

SUBNET_ID_2=$(aws ec2 create-subnet --vpc-id $VPC_ID \
--cidr-block 10.10.1.0/24 --availability-zone ${AWS_REGION}b \
--tag-specifications \
'ResourceType=subnet,Tags=[{Key=Name,Value=DemoSubnet2}]' \
--output text --query Subnet.SubnetId)

# If needed, to find Availability Zone IDs for a Region that are consistent, run this
# command:
aws ec2 describe-availability-zones --region $AWS_REGION

# Associate the route table with the two subnets:
aws ec2 associate-route-table \
--route-table-id $ROUTE_TABLE_ID --subnet-id $SUBNET_ID_1

aws ec2 associate-route-table \
--route-table-id $ROUTE_TABLE_ID --subnet-id $SUBNET_ID_2

# Validation checks

# Retrieve the configuration of the subnets you created and verify that they are in
# the same VPC but different AZs:
aws ec2 describe-subnets --subnet-ids $SUBNET_ID_1
aws ec2 describe-subnets --subnet-ids $SUBNET_ID_2

# Validate that the route table you created is associated with the two subnets:
aws ec2 describe-route-tables --route-table-ids $ROUTE_TABLE_ID

# Clean up

# Delete your subnets:
aws ec2 delete-subnet --subnet-id $SUBNET_ID_1
aws ec2 delete-subnet --subnet-id $SUBNET_ID_2

# Delete your route table:
aws ec2 delete-route-table --route-table-id $ROUTE_TABLE_ID

# Delete your VPC:
aws ec2 delete-vpc --vpc-id $VPC_ID

# Unset your manually created environment variables:
unset VPC_ID
unset ROUTE_TABLE_ID
unset SUBNET_ID_1
unset SUBNET_ID_2
