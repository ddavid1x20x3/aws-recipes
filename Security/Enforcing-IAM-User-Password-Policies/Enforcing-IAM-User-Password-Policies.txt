# Enforcing IAM User Password Policies in Your AWS Account

# Problem:
# Your security policy requires that you must enforce a password policy for all users
# within your AWS account. The password policy sets a 90-day expiration, and passwords
# must be made up of a minimum of 16 characters including lowercase and uppercase letters,
# numbers, and symbols.

# Solution:
# Set a password policy for IAM users in your AWS account. Create an IAM group, an
# IAM user, and add the user to the group to verify that the policy is being enforced.

# Set an IAM password policy using the AWS CLI to require lowercase and uppercase 
# letters, symbols, and numbers. The policy should indicate a minimum of 16 characters,
# a maximum password age of 90 days, and password reuse prevented:
aws iam update-account-password-policy \
--minimum-password-length 16 \
--require-symbols \
--require-numbers \
--require-uppercase-characters \
--require-lowercase-characters \
--allow-users-to-change-password \
--max-password-age 90 \
--password-reuse-prevention 1

# Create an IAM group:
aws iam create-group --group-name <group-name>

# Attach the ReadOnlyAccess policy to the group:
aws iam attach-group-policy --group-name <group-name> \
--policy-arn arn:aws:iam::aws:policy/AWSBillingReadOnlyAccess

# Create an IAM user:
aws iam create-user --user-name <user-name>

# Use Secrets Manager to generate a password that conforms to your password policy:
RANDOM_STRING=$(aws secretsmanager get-random-password \
--password-length 16 --require-each-included-type \
--output text \
--query RandomPassword)

# Create a login profile for the user that specifies a password:
aws iam create-login-profile --user-name <user-name> \
--password $RANDOM_STRING

# Add the user to the group you created for billing view-only access:
aws iam add-user-to-group --group-name <group-name> \
--user-name <user-name> 

# Verify that the password policy you set is now active:
aws iam get-account-password-policy

# Clean up 

# Delete the login profiles that you created:
aws iam delete-login-profile --user-name <user-name>

# Remove the user from the group:
aws iam remove-user-from-group --user-name <user-name> \
--group-name <group-name>

# Detach the policy from the group:
aws iam detach-group-policy --group-name <group-name> \
--policy-arn arn:aws:iam::aws:policy/AWSBillingReadOnlyAccess

# Delete the users that you created:
aws iam delete-user --user-name <user-name>

# Delete the account password policy that you configured:
aws iam delete-account-password-policy

# Unset the local variables you created:
unset RANDOM_STRING
