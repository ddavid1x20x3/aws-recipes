# Creating and Assuming an IAM Role

# Retrieve the ARN for your user and set it as a variable:
PRINCIPAL_ARN=$(aws sts get-caller-identity --query Arn --output text)

# Use the sed command to replace PRINCIPAL_ARN in the assume-role-policy-template.json
# file and generate the assume-role-policy.json file:
sed -e "s|PRINCIPAL_ARN|${PRINCIPAL_ARN}|g" \
assume-role-policy-template.json > assume-role-policy.json

# Create a role and specify the assume role policy file:
ROLE_ARN=$(aws iam create-role --role-name <role-name> \
--assume-role-policy-document file://assume-role-policy.json \
--output text --query Role.Arn)

# Assume the role:
aws sts assume-role --role-arn $ROLE_ARN \
--role-session-name <role-name>

# Clean up 

# Detach the PowerUserAccess policy from the role:
aws iam detach-role-policy --role-name <role-name> \
--policy-arn arn:aws:iam::aws:policy/PowerUserAccess

# Delete the IAM role:
aws iam delete-role --role-name <role-name>

# Unset your local variables:
unset ROLE_ARN
unset PRINCIPAL_ARN